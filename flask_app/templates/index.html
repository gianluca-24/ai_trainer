<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Workout Session</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Mediapipe JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #f4f4f4; 
      margin: 0; 
      padding: 0; 
      text-align: center;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    h1 { color: #333; margin-top: 16px; }

    .main-container {
      display: flex;
      flex: 1;
      padding: 20px;
      gap: 20px;
    }

    .feedback-panel {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 24px 0 #0001;
      display: flex;
      flex-direction: column;
      max-width: 300px;
      position: relative;
    }

    .video-panel {
      flex: 2;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .recap-panel {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 24px 0 #0001;
      display: flex;
      flex-direction: column;
      max-width: 300px;
    }

    #video-container {
      position: relative;
      width: 100%;
      max-width: 800px;
      aspect-ratio: 4 / 3;
    }
    #output {
      width: 100%;
      border: 4px solid #333;
      border-radius: 16px;
      background: #000;
      box-shadow: 0 4px 24px 0 #0001;
    }
    #workout-config {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.95);
      padding: 30px;
      border-radius: 16px;
      z-index: 20;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
      min-width: 300px;
    }
    #workout-config.active {
      display: block;
    }
    .config-input {
      margin: 15px 0;
    }
    .config-input label {
      display: block;
      margin-bottom: 8px;
      font-size: 16px;
    }
    .config-input input {
      width: 120px;
      padding: 8px;
      font-size: 16px;
    }
    .config-buttons {
      margin-top: 20px;
    }
    .config-buttons button, .config-buttons a {
      margin: 0 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      text-decoration: none;
      display: inline-block;
    }
    .start-btn {
      background: #4CAF50;
      color: white;
    }
    .cancel-btn {
      background: #f44336;
      color: white;
    }
    #feedback {
      background: rgba(255,255,255,0.92);
      padding: 15px 20px;
      border-radius: 12px;
      font-size: 25px;
      color: #222;
      text-align: left;
      margin-bottom: 20px;
      min-height: 40px;
      box-shadow: 0 2px 8px 0 #0002;
    }
    #rep-count {
      font-size: 24px;
      background: rgba(0,0,0,0.65);
      color: #fff;
      padding: 12px 24px;
      border-radius: 12px;
      margin-bottom: 10px;
      letter-spacing: 1px;
      font-weight: bold;
    }
    #set-count {
      font-size: 24px;
      background: rgba(0,0,0,0.65);
      color: #fff;
      padding: 12px 24px;
      border-radius: 12px;
      margin-bottom: 10px;
      letter-spacing: 1px;
      font-weight: bold;
    }
    #stage-indicator {
      font-size: 24px;
      background: rgba(0,0,0,0.65);
      color: #fff;
      padding: 12px 24px;
      border-radius: 12px;
      margin-bottom: 10px;
      letter-spacing: 1px;
      font-weight: bold;
    }
    #rest-timer {
      font-size: 48px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 20px 40px;
      border-radius: 16px;
      letter-spacing: 2px;
      font-weight: bold;
      display: none;
      position: relative;
    }
    #rest-timer.active {
      display: block;
    }
    #terminate-workout {
      position: absolute;
      bottom: 20px;
      left: 20px;
      padding: 10px 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      display: none;
      transition: background-color 0.2s;
      z-index: 100;
    }
    #terminate-workout:hover {
      background: #c82333;
    }
    #terminate-workout.active {
      display: block;
    }

    .recap-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #333;
    }

    .recap-content {
      text-align: left;
      font-size: 16px;
      color: #666;
    }

    .recap-item {
      padding: 10px;
      margin-bottom: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }

    .recap-item.completed {
      border-left-color: #4CAF50;
    }

    .recap-item.current {
      border-left-color: #2196F3;
    }

    .recap-item.pending {
      border-left-color: #9E9E9E;
    }

    .recap-item.incomplete {
      border-left-color: #FFA500;
    }

    .recap-item.superset {
      border-left-color: #9C27B0;
    }

    @media (max-width: 1200px) {
      .main-container {
        flex-direction: column;
      }
      .feedback-panel, .recap-panel {
        max-width: none;
      }
    }

    .start-training {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 2rem auto;
            padding: 1.2rem;
            background: #4CAF50;
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .start-training:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }

    .workout-recap-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.2);
      z-index: 1000;
      max-width: 500px;
      width: 90%;
    }

    .workout-recap-popup.active {
      display: block;
    }

    .workout-recap-popup h2 {
      color: #333;
      margin-top: 0;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .workout-recap-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .workout-recap-stat {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }

    .workout-recap-stat strong {
      display: block;
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
    }

    .workout-recap-stat span {
      color: #333;
      font-size: 1.2rem;
      font-weight: bold;
    }

    .workout-recap-score {
      text-align: center;
      margin: 1.5rem 0;
      padding: 1rem;
      background: #e8f5e9;
      border-radius: 8px;
    }

    .workout-recap-score strong {
      display: block;
      color: #2e7d32;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .workout-recap-score span {
      color: #1b5e20;
      font-size: 2rem;
      font-weight: bold;
    }

    .workout-recap-mistakes {
      margin: 1.5rem 0;
      padding: 1rem;
      background: #fff3cd;
      border-radius: 8px;
    }

    .workout-recap-mistakes h3 {
      color: #856404;
      margin: 0 0 0.5rem 0;
      font-size: 1.1rem;
    }

    .workout-recap-mistakes p {
      color: #666;
      margin: 0;
      font-size: 0.9rem;
    }

    .workout-recap-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .workout-recap-buttons a {
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .workout-recap-buttons .profile-btn {
      background: #4CAF50;
      color: white;
    }

    .workout-recap-buttons .profile-btn:hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }

    .popup-overlay.active {
      display: block;
    }

    #disclaimer-popup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.98);
      padding: 40px;
      border-radius: 16px;
      z-index: 30;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: none;
      max-width: 600px;
      width: 90%;
      text-align: left;
    }
    #disclaimer-popup.active {
      display: block;
    }
    #disclaimer-popup h2 {
      color: #333;
      margin-top: 0;
      margin-bottom: 20px;
      text-align: center;
    }
    #disclaimer-popup .instruction-section {
      margin-bottom: 25px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }
    #disclaimer-popup .instruction-section h3 {
      color: #2e7d32;
      margin-top: 0;
      margin-bottom: 10px;
    }
    #disclaimer-popup .voice-commands {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    #disclaimer-popup .voice-command {
      background: #e8f5e9;
      color: #1b5e20;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
    }
    #disclaimer-popup .disclaimer-buttons {
      text-align: center;
      margin-top: 30px;
    }
    #disclaimer-popup .okay-btn {
      background: #4CAF50;
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    #disclaimer-popup .okay-btn:hover {
      background: #45a049;
    }
  </style>
</head>
<body>
  <h1>Workout Session</h1>
  <div class="main-container">
    <div class="feedback-panel">
      <div id="feedback"></div>
      <div id="set-count">Set: 0</div>
      <div id="rep-count">Reps: 0</div>
      <div id="stage-indicator">Stage: Ready</div>
      <button id="terminate-workout" onclick="terminateWorkout()">Terminate Workout</button>
    </div>

    <div class="video-panel">
      <div id="video-container">
        <canvas id="output" width="800" height="600"></canvas>
        <div id="rest-timer">Rest: 60s</div>
        <div id="workout-config">
          <h3>Configure Workout</h3>
          <div class="config-input">
            <label for="sets">Number of Sets:</label>
            <input type="number" id="sets" min="1" max="10" value="3">
          </div>
          <div class="config-input">
            <label for="reps">Number of Repetitions:</label>
            <input type="number" id="reps" min="1" max="100" value="10">
          </div>
          <div class="config-input">
            <label for="rest-time">Rest Time (min. 60 seconds):</label>
            <input type="number" id="rest-time" min="10" max="300" value="60">
          </div>
          <div class="config-buttons">
            <button class="start-btn" onclick="startWorkout()">Start Workout</button>
            <a class="cancel-btn" href="{{ url_for('profile') }}" class="start-training">Cancel</a>
          </div>
        </div>
        <div id="disclaimer-popup">
          <h2>Workout Instructions</h2>
          <div class="instruction-section">
            <h3>ðŸ“¹ Camera Positioning</h3>
            <p>Position your camera at a <strong>45-degree angle</strong> to capture your full body during the workout. Make sure you have enough space to perform the exercises safely.</p>
          </div>
          <div class="instruction-section">
            <h3>ðŸŽ¤ Voice Control Commands</h3>
            <p>You can use voice commands to configure your workout. Say these words clearly:</p>
            <div class="voice-commands">
              <span class="voice-command">repetitions</span>
              <span class="voice-command">sets</span>
              <span class="voice-command">timer</span>
              <span class="voice-command">start</span>
              <span class="voice-command">cancel</span>
              <span class="voice-command">ok</span>
            </div>
            <p><em>You can also say "ok" to close this instruction popup using voice control.</em></p>
          </div>
          <div class="instruction-section">
            <h3>ðŸ•’ Rest Period Commands</h3>
            <p>During rest periods, you can provide feedback on the set difficulty:</p>
            <div class="voice-commands">
              <span class="voice-command">good</span>
              <span class="voice-command">easy</span>
              <span class="voice-command">difficult</span>
              <span class="voice-command">terminate</span>
            </div>
            <p><em>Your feedback helps adjust the workout to your level - adding sets if too easy or reducing reps if too difficult.</em></p>
          </div>
          <div class="disclaimer-buttons">
            <button class="okay-btn" onclick="closeDisclaimer()">Okay</button>
          </div>
        </div>
        <div id="controls">
          <select id="exercise-select">
            <option value="pushup">Push-Up</option>
            <option value="squat">Squat</option>
          </select>
        </div>
      </div>
    </div>

    <div class="recap-panel">
      <div class="recap-title">Training Recap</div>
      <div id="recap-content" class="recap-content">
        <!-- Recap items will be added here dynamically -->
      </div>
    </div>
  </div>
  <video id="video" autoplay playsinline muted style="display:none"></video>
  <!-- Add popup overlay and recap popup -->
  <div class="popup-overlay"></div>
  <div class="workout-recap-popup">
    <h2>Workout Complete!</h2>
    <div class="workout-recap-stats">
      <div class="workout-recap-stat">
        <strong>Sets Completed</strong>
        <span id="recap-sets-completed">0</span>
      </div>
      <div class="workout-recap-stat">
        <strong>Sets Missed</strong>
        <span id="recap-sets-missed">0</span>
      </div>
      <div class="workout-recap-stat">
        <strong>Total Reps</strong>
        <span id="recap-total-reps">0</span>
      </div>
      <div class="workout-recap-stat">
        <strong>Supersets</strong>
        <span id="recap-supersets">0</span>
      </div>
      <div class="workout-recap-stat">
        <strong>Duration</strong>
        <span id="recap-duration">0s</span>
      </div>
    </div>
    <div class="workout-recap-score">
      <strong>Your Score</strong>
      <span id="recap-score">0</span>
    </div>
    <div class="workout-recap-mistakes">
      <h3>Form Corrections</h3>
      <p id="recap-mistakes">No corrections needed!</p>
    </div>
    <div class="workout-recap-buttons">
      <a href="{{ url_for('profile') }}" class="profile-btn">Go to Profile</a>
    </div>
  </div>
  <script>
    // Unlock voice on first user tap for all phones
    function unlockSpeech() {
      try {
        const dummy = new SpeechSynthesisUtterance('');
        speechSynthesis.speak(dummy);
        speechSynthesis.cancel();
      } catch(e) {}
    }
    window.addEventListener("click", unlockSpeech, {once: true});
    window.addEventListener("touchstart", unlockSpeech, {once: true});

    // Get the profile URL from Flask
    const profileUrl = "{{ url_for('profile') }}";

    // --- UI State ---
    let pushupCounter = 0;
    let pushupStage = null;
    let squatCounter = 0;
    let squatStage = "up";
    let currentExercise = "pushup";
    let lastMsg = null;
    let lastMsgTime = 0;
    let lastRepTime = 0;
    const FEEDBACK_DELAY = 5000; // ms
    const REP_CYCLE_DELAY = 2000; // ms - minimum time between rep cycles

    // Speech recognition setup
    let recognition;
    let isListening = false;
    let transcriptTimer = null;

    function setupSpeechRecognition() {
      if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onresult = function(event) {
          const transcript = Array.from(event.results)
            .map(result => result[0].transcript)
            .join('')
            .toLowerCase();

          // Clear any existing timer
          if (transcriptTimer) {
            clearTimeout(transcriptTimer);
          }

          // Display the transcript for debugging
          document.getElementById("feedback").innerText = "Heard: " + transcript;

          // Set a timer to clear the transcript after 0.5 seconds
          transcriptTimer = setTimeout(() => {
            document.getElementById("feedback").innerText = "";
          }, 500);

          // Handle voice commands
          if (transcript.includes('repetitions')) {
            // Try to find numbers in the transcript
            const numberMatch = transcript.match(/\d+/);
            if (numberMatch) {
              const reps = parseInt(numberMatch[0]);
              document.getElementById("feedback").innerText = "Heard: " + transcript + " (Extracted number: " + reps + ")";
              if (reps > 0 && reps <= 100) {
                document.getElementById('reps').value = reps;
                speak(`Reps set to ${reps}`);
                recognition.stop();
                setTimeout(() => recognition.start(), 100);
              }
            } else {
              // Try to convert written numbers
              const writtenNumbers = {
                'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5,
                'six': 6, 'seven': 7, 'eight': 8, 'nine': 9, 'ten': 10,
                'eleven': 11, 'twelve': 12, 'thirteen': 13, 'fourteen': 14, 'fifteen': 15,
                'sixteen': 16, 'seventeen': 17, 'eighteen': 18, 'nineteen': 19, 'twenty': 20,
                'twenty one': 21, 'twenty two': 22, 'twenty three': 23, 'twenty four': 24, 'twenty five': 25,
                'twenty six': 26, 'twenty seven': 27, 'twenty eight': 28, 'twenty nine': 29, 'thirty': 30,
                'thirty one': 31, 'thirty two': 32, 'thirty three': 33, 'thirty four': 34, 'thirty five': 35,
                'thirty six': 36, 'thirty seven': 37, 'thirty eight': 38, 'thirty nine': 39, 'forty': 40,
              };

              for (const [word, num] of Object.entries(writtenNumbers)) {
                if (transcript.includes(word)) {
                  document.getElementById("feedback").innerText = "Heard: " + transcript + " (Extracted word: " + word + " = " + num + ")";
                  if (num > 0 && num <= 100) {
                    document.getElementById('reps').value = num;
                    speak(`Reps set to ${num}`);
                    recognition.stop();
                    setTimeout(() => recognition.start(), 100);
                  }
                  break;
                }
              }
            }
          } else if (transcript.includes('sets')) {
            // Try to find numbers in the transcript
            const numberMatch = transcript.match(/\d+/);
            if (numberMatch) {
              const sets = parseInt(numberMatch[0]);
              document.getElementById("feedback").innerText = "Heard: " + transcript + " (Extracted number: " + sets + ")";
              if (sets > 0 && sets <= 10) {
                document.getElementById('sets').value = sets;
                speak(`Sets set to ${sets}`);
                recognition.stop();
                setTimeout(() => recognition.start(), 100);
              }
            } else {
              // Try to convert written numbers
              const writtenNumbers = {
                'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5,
                'six': 6, 'seven': 7, 'eight': 8, 'nine': 9, 'ten': 10,
                'eleven': 11, 'twelve': 12, 'thirteen': 13, 'fourteen': 14, 'fifteen': 15,
                'sixteen': 16, 'seventeen': 17, 'eighteen': 18, 'nineteen': 19, 'twenty': 20,
                'twenty one': 21, 'twenty two': 22, 'twenty three': 23, 'twenty four': 24, 'twenty five': 25,
                'twenty six': 26, 'twenty seven': 27, 'twenty eight': 28, 'twenty nine': 29, 'thirty': 30,
                'thirty one': 31, 'thirty two': 32, 'thirty three': 33, 'thirty four': 34, 'thirty five': 35,
                'thirty six': 36, 'thirty seven': 37, 'thirty eight': 38, 'thirty nine': 39, 'forty': 40,
              };

              for (const [word, num] of Object.entries(writtenNumbers)) {
                if (transcript.includes(word)) {
                  document.getElementById("feedback").innerText = "Heard: " + transcript + " (Extracted word: " + word + " = " + num + ")";
                  if (num > 0 && num <= 10) {
                    document.getElementById('sets').value = num;
                    speak(`Sets set to ${num}`);
                    recognition.stop();
                    setTimeout(() => recognition.start(), 100);
                  }
                  break;
                }
              }
            }
          } else if (transcript.includes('timer') || transcript.includes('set rest time')) {
            // Try to find numbers in the transcript
            const numberMatch = transcript.match(/\d+/);
            if (numberMatch) {
              const restTime = parseInt(numberMatch[0]);
              document.getElementById("feedback").innerText = "Heard: " + transcript + " (Extracted number: " + restTime + ")";
              if (restTime >= 60 && restTime <= 300) {
                document.getElementById('rest-time').value = restTime;
                speak(`Rest time set to ${restTime} seconds`);
                recognition.stop();
                setTimeout(() => recognition.start(), 100);
              } else {
                speak(`Please set rest time between 60 and 300 seconds`);
              }
            } else {
              // Try to convert written numbers
              const writtenNumbers = {
                'ten': 10, 'twenty': 20, 'thirty': 30, 'forty': 40, 'fifty': 50,
                'sixty': 60, 'seventy': 70, 'eighty': 80, 'ninety': 90, 'hundred': 100,
                'one hundred': 100, 'two hundred': 200, 'three hundred': 300
              };

              for (const [word, num] of Object.entries(writtenNumbers)) {
                if (transcript.includes(word)) {
                  document.getElementById("feedback").innerText = "Heard: " + transcript + " (Extracted word: " + word + " = " + num + ")";
                  if (num >= 60 && num <= 300) {
                    document.getElementById('rest-time').value = num;
                    speak(`Rest time set to ${num} seconds`);
                    recognition.stop();
                    setTimeout(() => recognition.start(), 100);
                  } else {
                    speak(`Please set rest time between 60 and 300 seconds`);
                  }
                  break;
                }
              }
            }
          } else if (transcript.includes('start')) {
            startWorkout();
            recognition.stop();
            setTimeout(() => recognition.start(), 100);
          } else if (transcript.includes('cancel')) {
            cancelConfig();
            recognition.stop();
            setTimeout(() => recognition.start(), 100);
          } else if (transcript.includes('ok')) {
            closeDisclaimer();
            recognition.stop();
            setTimeout(() => recognition.start(), 100);
          } else if (transcript.includes('terminate') && isResting) {
            terminateWorkout();
            recognition.stop();
            setTimeout(() => recognition.start(), 100);
          } else if (transcript.includes('good') && isResting && waitingForFeedback) {
            handleRestFeedback('good');
            recognition.stop();
            setTimeout(() => recognition.start(), 100);
          } else if (transcript.includes('easy') && isResting && waitingForFeedback) {
            handleRestFeedback('easy');
            recognition.stop();
            setTimeout(() => recognition.start(), 100);
          } else if (transcript.includes('difficult') && isResting && waitingForFeedback) {
            handleRestFeedback('difficult');
            recognition.stop();
            setTimeout(() => recognition.start(), 100);
          }
        };

        recognition.onerror = function(event) {
          console.error('Speech recognition error:', event.error);
          document.getElementById("feedback").innerText = "Speech recognition error: " + event.error;
        };

        recognition.onend = function() {
          if (isListening) {
            recognition.start();
          }
        };
      }
    }

    function toggleVoiceControl() {
      if (!recognition) {
        setupSpeechRecognition();
      }

      if (isListening) {
        recognition.stop();
        isListening = false;
        // speak('Voice control disabled');
      } else {
        recognition.start();
        isListening = true;
        speak('Position your camera at approximately a 45-degree angle.. You can say "sets", "repetitions", "timer", to configure your workout. Say "start" to start the workout. Say "cancel" to go back. During rest time: say "good" to keep the same settings, "easy" to add more sets, or "difficult" to reduce reps... You can also say "terminate" to end the workout... Say "ok" to close this instruction popup.');
      }
    }

    // Workout configuration
    let currentSet = 0;
    let totalSets = 3;
    let repsPerSet = 10;
    let workoutStarted = false;
    let isResting = false;
    let restStartTime = 0;
    let REST_DURATION = 60000; // Default 1 minute rest between sets
    let workoutStartTime = 0;
    let mistakes = {};
    let totalReps = 0;
    let completedSets = 0;

    // Message tracking
    let lastSpokenMessage = null; // Track the last spoken message
    const errorCooldowns = {}; // Key: error message, Value: last spoken time
    const ERROR_COOLDOWN_MS = 3000; // Minimum 3s between the same message

    // Disclaimer state
    let disclaimerShown = false;
    let cameraStarted = false;

    function trackMistake(mistake) {
      if (!mistakes[mistake]) {
        mistakes[mistake] = 0;
      }
      mistakes[mistake]++;
    }

    // Add completedReps tracking
    let completedReps = {};

    // Rest feedback tracking
    let waitingForFeedback = false;
    let feedbackAsked = false;

    function handleRestFeedback(feedback) {
      waitingForFeedback = false;
      feedbackAsked = true;
      
      switch(feedback) {
        case 'good':
          speak('Great! Keep up the good work');
          break;
        case 'easy':
          // Add one more set
          totalSets += 1;
          speak(`That was easy! I've added one more set. You now have ${totalSets} total sets`);
          break;
        case 'difficult':
          // Decrease reps by 2 (minimum 1)
          repsPerSet = Math.max(1, repsPerSet - 2);
          speak(`That was tough! I've reduced the reps to ${repsPerSet} for the remaining sets`);
          break;
      }
      
      // Update the set counter display and recap
      updateSetCounter();
      updateRecap();
    }

    function getErrorThreshold(errorMessage) {
      // Define error-specific thresholds
      if (errorMessage === "Raise your hips!") {
        return 120;
      } else if (errorMessage === "Bring your elbows closer") {
        return 80;
      } else if (errorMessage === "Lower your hips!") {
        return 120;
      } else if (errorMessage === "Widen your hands!") {
        return 80;
      } else if (errorMessage === "Bring your hands closer") {
        return 80;
      }

      return 120; // default threshold
    }

    function showWorkoutRecap(completedSets, setsMissed, totalReps, totalTime, mistakes, score, supersets) {
      // Stop the camera when showing recap
      if (camera) {
        camera.stop();
      }

      // Update popup content
      document.getElementById('recap-sets-completed').textContent = completedSets;
      document.getElementById('recap-sets-missed').textContent = setsMissed;
      document.getElementById('recap-total-reps').textContent = totalReps;
      document.getElementById('recap-supersets').textContent = supersets;

      // Format duration
      const minutes = Math.floor(totalTime / 60);
      const seconds = Math.round(totalTime % 60);
      const durationStr = minutes > 0 ?
        `${minutes}m ${seconds}s` :
        `${seconds}s`;
      document.getElementById('recap-duration').textContent = durationStr;

      // Update score
      document.getElementById('recap-score').textContent = score;

      // Update mistakes with normalized values
      const mistakesText = Object.entries(mistakes)
        .map(([mistake, count]) => {
          const threshold = getErrorThreshold(mistake);
          const normalizedCount = Math.ceil(count / threshold);
          return `${mistake}: ${normalizedCount}`;
        })
        .join(', ');
      document.getElementById('recap-mistakes').textContent =
        mistakesText || 'No corrections needed!';

      // Show popup and overlay
      document.querySelector('.popup-overlay').classList.add('active');
      document.querySelector('.workout-recap-popup').classList.add('active');
    }

    function saveWorkoutSummary() {
      const workoutEndTime = Date.now();
      const totalTime = (workoutEndTime - workoutStartTime) / 1000; // Convert to seconds

      // Calculate actual missed sets (excluding supersets)
      const actualMissedSets = totalSets - completedSets;

      // Convert mistakes object to string with normalized values
      const mistakesStr = Object.entries(mistakes)
        .map(([mistake, count]) => {
          const threshold = getErrorThreshold(mistake);
          const normalizedCount = Math.ceil(count / threshold);
          return `${mistake}: ${normalizedCount}`;
        })
        .join('; ');

      // Calculate total number of errors
      const totalErrors = Object.keys(mistakes).length;

      // Calculate workout score
      const timeInMinutes = totalTime / 60;
      const repsPerMinute = totalReps / timeInMinutes;

      // Set Factor: 1 + 0.1 * (completedSets - 1)
      const setFactor = 1 + 0.1 * (completedSets - 1);

      // Error Penalty: e^(-0.1 * totalErrors)
      const errorPenalty = Math.exp(-0.1 * totalErrors);

      // Miss Penalty: e^(-0.2 * missedSets)
      const missPenalty = Math.exp(-0.2 * actualMissedSets);

      // Superset Bonus: 1 + 0.2 * supersets
      const supersets = Object.values(completedReps).filter(reps => reps > repsPerSet).length;
      const supersetBonus = 1 + (0.2 * supersets);

      // Final Score: Base score * set factor * error penalty * miss penalty * superset bonus
      const baseScore = repsPerMinute * 10; // Multiply by 10 to get a more readable number
      const workoutScore = Math.round(baseScore * setFactor * errorPenalty * missPenalty * supersetBonus);

      console.log('Score calculation:', {
        baseScore,
        setFactor,
        errorPenalty,
        missPenalty,
        supersetBonus,
        finalScore: workoutScore
      });

      // Show workout recap popup
      showWorkoutRecap(completedSets, actualMissedSets, totalReps, totalTime, mistakes, workoutScore, supersets);

      // Create CSV content with just the data row
      const csvContent = [completedSets, actualMissedSets, totalReps, totalTime, mistakesStr, workoutScore, supersets].join(',');

      // Send to server to save
      fetch('/save_workout_summary', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          csv_content: csvContent
        })
      })
      .then(response => response.json())
      .then(data => {
        if (!data.success) {
          console.error('Failed to save workout summary');
        }
      })
      .catch(error => {
        console.error('Error saving workout summary:', error);
      });
    }

    function showWorkoutConfig() {
      document.getElementById('workout-config').classList.add('active');
      // Start voice control when config is shown
      if (!isListening) {
        toggleVoiceControl();
      }
    }

    function startWorkout() {
      totalSets = parseInt(document.getElementById('sets').value);
      repsPerSet = parseInt(document.getElementById('reps').value);
      REST_DURATION = parseInt(document.getElementById('rest-time').value) * 1000;
      currentSet = 1;
      completedSets = 0;
      workoutStarted = true;
      workoutStartTime = Date.now();
      mistakes = {};
      totalReps = 0;
      // Reset feedback variables
      waitingForFeedback = false;
      feedbackAsked = false;
      document.getElementById('workout-config').classList.remove('active');
      speak(`Starting workout with ${totalSets} sets of ${repsPerSet} reps and ${REST_DURATION/1000} seconds rest`);
      updateSetCounter();
      // Reset rep counter for first set
      if (currentExercise === "pushup") {
        pushupCounter = 0;
        pushupStage = null;
      } else {
        squatCounter = 0;
        squatStage = "up";
      }
      document.getElementById("rep-count").innerText = "Reps: 0";
      updateRecap();
      if (isListening) {
        toggleVoiceControl();
      }
    }

    function cancelConfig() {
      document.getElementById('workout-config').classList.remove('active');
      // Stop voice control when config is cancelled
      if (isListening) {
        toggleVoiceControl();
      }
      // Redirect to profile page
      window.location.href = '/profile';
    }

    function updateSetCounter() {
      document.getElementById('set-count').innerText = `Set: ${currentSet}/${totalSets}`;
    }

    function updateRecap() {
      const recapContent = document.getElementById('recap-content');
      recapContent.innerHTML = ''; // Clear existing recap

      // Add completed sets
      for (let i = 1; i < currentSet; i++) {
        const setItem = document.createElement('div');
        const isSuperset = completedReps[i] > repsPerSet;
        setItem.className = isSuperset ? 'recap-item superset' : 'recap-item completed';
        setItem.innerHTML = `
          <strong>Set ${i}${isSuperset ? ' (Superset)' : ''}</strong><br>
          Completed ${completedReps[i]}/${repsPerSet} reps<br>
          ${currentExercise === 'pushup' ? 'Push-ups' : 'Squats'}
        `;
        recapContent.appendChild(setItem);
      }

      // Add current set if workout is in progress
      if (workoutStarted && currentSet <= totalSets) {
        const currentSetItem = document.createElement('div');
        const currentReps = currentExercise === "pushup" ? pushupCounter : squatCounter;
        const isSuperset = currentReps > repsPerSet;

        // Check if this is an incomplete set
        if (currentReps > 0 && currentReps < repsPerSet) {
          currentSetItem.className = 'recap-item incomplete';
          currentSetItem.innerHTML = `
            <strong>Set ${currentSet} (Incomplete)</strong><br>
            ${currentReps}/${repsPerSet} reps completed<br>
            ${currentExercise === 'pushup' ? 'Push-ups' : 'Squats'}
          `;
        } else {
          currentSetItem.className = isSuperset ? 'recap-item superset' : 'recap-item current';
          currentSetItem.innerHTML = `
            <strong>Set ${currentSet}${isSuperset ? ' (Superset)' : ' (Current)'}</strong><br>
            ${currentReps}/${repsPerSet} reps completed<br>
            ${currentExercise === 'pushup' ? 'Push-ups' : 'Squats'}
          `;
        }
        recapContent.appendChild(currentSetItem);
      }

      // Add upcoming sets
      for (let i = currentSet + 1; i <= totalSets; i++) {
        const setItem = document.createElement('div');
        setItem.className = 'recap-item pending';
        setItem.innerHTML = `
          <strong>Set ${i}</strong><br>
          ${repsPerSet} reps planned<br>
          ${currentExercise === 'pushup' ? 'Push-ups' : 'Squats'}
        `;
        recapContent.appendChild(setItem);
      }
    }

    // function checkSetCompletion() {
    //   const currentReps = currentExercise === "pushup" ? pushupCounter : squatCounter;
    //   // Only check for set completion if user breaks position
    //   if (pushupStage === null && currentReps > 0) {
    //     if (currentSet < totalSets) {
    //       completedSets++;
    //       completedReps[currentSet] = currentReps; // Store the actual reps completed before resetting counters
    //       currentSet++;
    //       isResting = true;
    //       restStartTime = Date.now();
    //       feedbackAsked = false; // Reset feedback flag for new rest period
    //       const isSuperset = currentReps > repsPerSet;
    //       speak(`Set complete! ${isSuperset ? 'Great superset!' : ''} Take a ${REST_DURATION/1000} second rest before starting set ${currentSet}.`);
          
          // Ask for feedback if not the last set
          // if (currentSet <= totalSets) {
          //     if (isResting && !feedbackAsked) {
          //       waitingForFeedback = true;
          //       speak('How did that set feel? Good, Easy, or Difficult?');
          //     }
            
    //       }
          
    //       updateSetCounter();
    //       // Reset rep counter for new set
    //       if (currentExercise === "pushup") {
    //         pushupCounter = 0;
    //         pushupStage = null;
    //       } else {
    //         squatCounter = 0;
    //         squatStage = "up";
    //       }
    //       document.getElementById("rep-count").innerText = "Reps: 0";
    //       updateRecap(); // Move updateRecap after resetting counters
    //     } else {
    //       // Remove duplicate workout complete message
    //       completedSets++;
    //       completedReps[currentSet] = currentReps; // Store the actual reps completed
    //       const isSuperset = currentReps > repsPerSet;
    //       speak(`Workout complete! ${isSuperset ? 'Great superset!' : ''} Great job!`);
    //       workoutStarted = false;
    //       saveWorkoutSummary(); // Save summary when workout is complete
    //       updateRecap();
    //     }
    //   }
    // }

    function checkRestPeriod() {
      if (isResting) {
        const restTimeElapsed = Date.now() - restStartTime;
        if (restTimeElapsed >= REST_DURATION) {
          isResting = false;
          waitingForFeedback = false; // Reset feedback state
          feedbackAsked = false; // Reset feedback flag
          const endMessage = `Rest period over. Get into ${currentExercise === 'pushup' ? 'pushup' : 'squat'} position to start set ${currentSet}`;
          speak(endMessage);
          document.getElementById("feedback").innerText = endMessage;
          document.getElementById('rest-timer').classList.remove('active');
          // Ensure rep counter is at 0 when rest period ends
          document.getElementById("rep-count").innerText = "Reps: 0";
        } else {
          const remainingSeconds = Math.ceil((REST_DURATION - restTimeElapsed) / 1000);

          // Only speak at specific intervals
          if (remainingSeconds === REST_DURATION/1000) {
            // Initial message
            // speak(`Rest for ${remainingSeconds} seconds`)
            // 
            //;
          } else if (remainingSeconds === 30) {
            // 30 seconds remaining
            speak('30 seconds left');
          } else if (remainingSeconds === 15) {
            // 15 seconds remaining with preparation message
            speak('15 seconds left, start getting into position');
          }
        }
      }
    }

    function angle(a, b, c) {
      const ab = [a[0]-b[0], a[1]-b[1]];
      const cb = [c[0]-b[0], c[1]-b[1]];
      const dot = ab[0]*cb[0] + ab[1]*cb[1];
      const magA = Math.hypot(...ab), magC = Math.hypot(...cb);
      return Math.abs((Math.acos(dot / (magA*magC))) * 180 / Math.PI);
    }

    function getCoord(landmarks, side, joint) {
      const idxs = {
        "left_shoulder": 11, "right_shoulder": 12,
        "left_hip": 23, "right_hip": 24,
        "left_knee": 25, "right_knee": 26,
        "left_ankle": 27, "right_ankle": 28,
        "left_wrist": 15, "right_wrist": 16,
        "left_elbow": 13, "right_elbow": 14
      };
      return [landmarks[idxs[side+"_"+joint]].x, landmarks[idxs[side+"_"+joint]].y];
    }

    function countPushup(landmarks) {
      let errorMessage = null;

      const ls = getCoord(landmarks, "left", "shoulder");
      const lh = getCoord(landmarks, "left", "hip");
      const lk = getCoord(landmarks, "left", "knee");
      const la = getCoord(landmarks, "left", "ankle");
      const lw = getCoord(landmarks, "left", "wrist");
      const le = getCoord(landmarks, "left", "elbow");
      const rs = getCoord(landmarks, "right", "shoulder");
      const rh = getCoord(landmarks, "right", "hip");
      const rk = getCoord(landmarks, "right", "knee");
      const ra = getCoord(landmarks, "right", "ankle");
      const rw = getCoord(landmarks, "right", "wrist");
      const re = getCoord(landmarks, "right", "elbow");

      const wd = Math.abs(Math.hypot(lw[0]-rw[0], lw[1]-rw[1])); // Distance between wrists
      const sd = Math.abs(Math.hypot(ls[0]-rs[0], ls[1]-rs[1])); // Distance between shoulders
      const lea = angle(ls, le, lw);
      const rea = angle(rs, re, rw);
      const lha = angle(ls, lh, lk);
      const rha = angle(rs, rh, rk);
      const lka = angle(lh, lk, la);
      const rka = angle(rh, rk, ra);
      const lla = angle(lw, le, ls); // Left elbow angle
      const rla = angle(rw, re, rs); // Right elbow angle
      const lsa = angle(le, ls, lh); // Left shoulder angle
      const rsa = angle(re, rs, rh); // Right shoulder angle

      const th_up = 160, th_down = 120;

      // Calculate proper hand width based on shoulder width
      const minHandWidth = sd * 1;  
      const maxHandWidth = sd * 1.5;

      // if rs, ra, ls, la cannot be seen, return [pushupCounter, "Move into frame"] only if not resting
      if (!isResting && (rs[0] === null || ra[0] === null || ls[0] === null || la[0] === null)) {
        return [pushupCounter, "Move into frame"];
      }

      // Check vertical alignment
      const rightHipToRightAnkle = Math.abs(rh[1] - ra[1]);
      const leftHipToLeftAnkle = Math.abs(lh[1] - la[1]);

      // Check if person is standing up and not in rest period
      if ((rightHipToRightAnkle > 0.2 || leftHipToLeftAnkle > 0.2) && !isResting) {
        if (pushupStage !== null) {
          // If they were doing pushups and now standing, handle the incomplete set
          const currentReps = pushupCounter;
          if (pushupCounter > 0 && pushupCounter < repsPerSet && currentSet < totalSets) {
            // Store the actual reps completed before resetting
            completedReps[currentSet] = pushupCounter;
            currentSet++;
            isResting = true;
            restStartTime = Date.now();
            feedbackAsked = false; // Reset feedback flag for new rest period
            speak(`Set incomplete! Take a ${REST_DURATION/1000} second rest before starting set ${currentSet}.`);
            
            if (currentSet <= totalSets) {
              if (isResting && !feedbackAsked) {
                waitingForFeedback = true;
                speak('How did that set feel? Good, Easy, or Difficult?');
              }
            }
            
            // Mark this set as incomplete in the recap
            const recapContent = document.getElementById('recap-content');
            // Clear the current set item if it exists
            const currentSetItems = recapContent.getElementsByClassName('recap-item current');
            if (currentSetItems.length > 0) {
              currentSetItems[0].remove();
            }
            // Add the incomplete set
            const currentSetItem = document.createElement('div');
            currentSetItem.className = 'recap-item incomplete';
            currentSetItem.innerHTML = `
              <strong>Set ${currentSet} (Incomplete)</strong><br>
              ${currentReps}/${repsPerSet} reps completed<br>
              ${currentExercise === 'pushup' ? 'Push-ups' : 'Squats'}
            `;
            recapContent.insertBefore(currentSetItem, recapContent.firstChild);
          }

          if (pushupCounter > 0 && pushupCounter >= repsPerSet && currentSet < totalSets) {
            completedSets++;
            completedReps[currentSet] = pushupCounter;
            currentSet++;
            isResting = true;
            restStartTime = Date.now();
            feedbackAsked = false; // Reset feedback flag for new rest period
            const isSuperset = pushupCounter > repsPerSet;
            speak(`Set complete! ${isSuperset ? 'Great superset!' : ''}! Take a ${REST_DURATION/1000} second rest before starting set ${currentSet}.`);
            
            if (currentSet <= totalSets) {
              if (isResting && !feedbackAsked) {
                waitingForFeedback = true;
                speak('How did that set feel? Good, Easy, or Difficult?');
              }
            }
            updateRecap();
            updateSetCounter();
            // Reset rep counter for new set
            pushupCounter = 0;
            pushupStage = null;
            document.getElementById("rep-count").innerText = "Reps: 0";
            
          } 
          // handle the case where the user is in the last set and has completed the reps
          if (pushupCounter > 0 && currentSet === totalSets) {
            completedSets++;
            completedReps[currentSet] = pushupCounter; // Store the actual reps completed
            const isSuperset = pushupCounter > repsPerSet;
            speak(`Workout complete! ${isSuperset ? 'Great superset!' : ''} Great job!`);
            workoutStarted = false;
            isResting = false;
            updateRecap();
            updateSetCounter();
            document.getElementById('rest-timer').classList.remove('active');
            document.getElementById('terminate-workout').classList.remove('active');
            saveWorkoutSummary();
            // Stop the camera when terminating workout
            if (camera) {
              camera.stop();
            }
          }
          // else {
          //   workoutStarted = false;
          // }
        }
        pushupStage = null;
        // Only return the "Get into pushup position" message if we're not in rest period
        return [pushupCounter, ''];
      }

      // Initial position check
      if (pushupStage === null && !isResting && (rightHipToRightAnkle < 0.2 || leftHipToLeftAnkle < 0.2)) {

        if ((lha >= 165 && lka >= 165) || (rha >= 165 && rka >= 165)) {
          if (wd >= minHandWidth && wd <= maxHandWidth) {
            if (lea >= th_up || rea >= th_up) {
              pushupStage = 'up';
              return [pushupCounter, "You can start pushing!"];
            } else {
              trackMistake("Straighten your arms");
              return [pushupCounter, "Straighten your arms"];
            }
          } else {
            if (wd < minHandWidth) {
              trackMistake("Widen your hands");
              errorMessage = "Widen your hands";
            }
            else if (wd > maxHandWidth) {
              trackMistake("Bring your hands closer");
              errorMessage = "Bring your hands closer";
            }
            return [pushupCounter, errorMessage];
          }
        } else {
          // Check if hips are too high or too low
          if (lha < 165 || rha < 165) {
            trackMistake("Raise your hips!");
            errorMessage = "Raise your hips!";
          } 
          else if (lha > 177 || rha > 177) {
            trackMistake("Lower your hips!");
            errorMessage = "Lower your hips!";
          } 
          else {
            // Fallback for other alignment issues
            trackMistake("Align your hips!");
            errorMessage = "Align your hips!";
          }
          return [pushupCounter, errorMessage];
        }
      }

      // Count reps
      if (pushupStage === 'down' && (lea >= th_up || rea >= th_up)) {
        pushupStage = "up";
        pushupCounter += 1;
        totalReps += 1;
        lastRepTime = Date.now();
      }

      if (pushupStage === 'up' && (lea <= th_down || rea <= th_down)) {
        pushupStage = "down";
      }

      // // i want to display: lha, rha, lsa, rsa
      // const feedback = `lha: ${lha} rha: ${rha} lsa: ${lsa} rsa: ${rsa}`;
      // document.getElementById("feedback").innerText = feedback;

      // Form check during exercise
      if (pushupStage === 'up' || pushupStage === 'down') {
        if (lha < 165 || rha < 165) {
          trackMistake("Raise your hips!");
          errorMessage = "Raise your hips!";
        }
        else if (lha > 177 || rha > 177) {
          trackMistake("Lower your hips!");
          errorMessage = "Lower your hips!";
        }
        
        else if (lla < 15 || rla < 15){
          trackMistake("Widen your elbows");
          errorMessage = "Widen your elbows";
        }
        if (errorMessage) return [pushupCounter, errorMessage];
      }

      return [pushupCounter, null];
    }

    function countSquat(landmarks) {

      // If we're not in resting state and user is not in squat position, prompt to get into position
      if (!isResting && squatStage === "up") {
        return [squatCounter, "Get into squat position to start the set"];
      }

      // Simple squat logic
      const hip = [landmarks[23].x, landmarks[23].y];
      const knee = [landmarks[25].x, landmarks[25].y];
      const ankle = [landmarks[27].x, landmarks[27].y];
      const kneeAngle = angle(hip, knee, ankle);
      let feedback = "";
      if (squatStage === "up" && kneeAngle < 100) {
        squatStage = "down";
        feedback = "Good! Go up!";
      }
      if (squatStage === "down" && kneeAngle > 160) {
        squatStage = "up";
        squatCounter += 1;
        feedback = "Rep counted!";
      }
      return [squatCounter, feedback];
    }

    function speak(msg) {
      if (!msg) return;

      // Check if this message is in cooldown
      const now = Date.now();
      if (errorCooldowns[msg] && now - errorCooldowns[msg] < ERROR_COOLDOWN_MS) {
        return; // Skip if still in cooldown
      }

      // Update cooldown for this message
      errorCooldowns[msg] = now;

      // Never speak the same message twice in a row
      if (msg === lastSpokenMessage) {
        return;
      }

      // Update the last spoken message
      lastSpokenMessage = msg;

      const utterance = new SpeechSynthesisUtterance(msg);
      utterance.lang = "en-US";
      speechSynthesis.speak(utterance);
    }

    function updateStageIndicator() {
      const stageElement = document.getElementById('stage-indicator');
      if (currentExercise === 'pushup') {
        if (pushupStage === null) {
          stageElement.innerText = 'Stage: Ready';
        } else if (pushupStage === 'up') {
          stageElement.innerText = 'Stage: Up';
        } else if (pushupStage === 'down') {
          stageElement.innerText = 'Stage: Down';
        }
      } else {
        if (squatStage === 'up') {
          stageElement.innerText = 'Stage: Up';
        } else if (squatStage === 'down') {
          stageElement.innerText = 'Stage: Down';
        }
      }
    }

    function updateRestTimer() {
      const timerElement = document.getElementById('rest-timer');
      const terminateButton = document.getElementById('terminate-workout');
      if (isResting) {
        const restTimeElapsed = Date.now() - restStartTime;
        const remainingSeconds = Math.ceil((REST_DURATION - restTimeElapsed) / 1000);
        timerElement.innerText = `Rest: ${remainingSeconds}s`;
        timerElement.classList.add('active');
        terminateButton.classList.add('active');
      } else {
        timerElement.classList.remove('active');
        terminateButton.classList.remove('active');
      }
    }

    function terminateWorkout() {
      workoutStarted = false;
      isResting = false;
      document.getElementById('rest-timer').classList.remove('active');
      document.getElementById('terminate-workout').classList.remove('active');
      saveWorkoutSummary();
      // Stop the camera when terminating workout
      if (camera) {
        camera.stop();
      }
      
    }

    function onResults(results) {
      const canvas = document.getElementById("output");
      const ctx = canvas.getContext('2d');
      ctx.save();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

      let reps = 0, feedback = "";
      if (results.poseLandmarks) {
        drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
        drawLandmarks(ctx, results.poseLandmarks, {color: '#FF0000', lineWidth: 2});

        // Check if workout config popup is active
        const configPopupActive = document.getElementById('workout-config').classList.contains('active');
        
        if (!workoutStarted && disclaimerShown && !configPopupActive) {
          showWorkoutConfig();
        } else if (!isResting && workoutStarted && !configPopupActive) {
          if (currentExercise === "pushup") {
            [reps, feedback] = countPushup(results.poseLandmarks);
          } else {
            [reps, feedback] = countSquat(results.poseLandmarks);
          }
          document.getElementById("rep-count").innerText = `Reps: ${reps}/${repsPerSet}`;
          updateRecap(); // Update recap with current reps in real-time
          if (feedback) {
            document.getElementById("feedback").innerText = feedback;
            
            // Check if this is an error message and if its count is a multiple of the threshold
            if (mistakes[feedback]) {
              const errorCount = mistakes[feedback];
              const threshold = getErrorThreshold(feedback);
              // debug prints
              // console.log("mistakes[feedback]", mistakes[feedback]);
              // console.log("errorCount", errorCount);
              // console.log("threshold", threshold);
              
              if (errorCount % threshold === 0) {
                speak(feedback);
              }
            } else {
              // For non-error messages (like "Rep counted!" or "Good! Go up!"), always speak
              speak(feedback);
            }
          }
          // checkSetCompletion();
        }
        
        // Only check rest period and update indicators if config popup is not active
        if (!configPopupActive) {
          checkRestPeriod();
          updateStageIndicator();
          updateRestTimer();
        }
      } else if (!document.getElementById('workout-config').classList.contains('active') && !isResting) {
        // Only show "Move into frame" message if config popup is not active
        const noPoseMessage = "Move into frame";
        if (document.getElementById("feedback").innerText !== noPoseMessage) {
          document.getElementById("feedback").innerText = noPoseMessage;
          speak(noPoseMessage);
        }
      }
      ctx.restore();
    }

    document.getElementById("exercise-select").addEventListener("change", (e) => {
      currentExercise = e.target.value;
      // Reset state
      pushupStage = null; pushupCounter = 0;
      squatStage = "up"; squatCounter = 0;
      currentSet = 0;
      workoutStarted = false;
      isResting = false;
      document.getElementById("rep-count").innerText = "Reps: 0";
      document.getElementById("set-count").innerText = "Set: 0";
      document.getElementById("stage-indicator").innerText = "Stage: Ready";
      document.getElementById("feedback").innerText = "";
      document.getElementById('rest-timer').classList.remove('active');
      updateRecap(); // Update recap when exercise changes
      showWorkoutConfig();
    });

    // Show disclaimer when page loads
    window.addEventListener('load', () => {
      showDisclaimer();
      setupSpeechRecognition();
    });

    // --- Camera/pose setup ---
    const videoElement = document.getElementById('video');
    const pose = new Pose({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
    });
    pose.setOptions({
      modelComplexity: 0,
      smoothLandmarks: true,
      enableSegmentation: false,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });
    pose.onResults(onResults);

    const camera = new Camera(videoElement, {
      onFrame: async () => {
        try {
          await pose.send({image: videoElement});
        } catch (error) {
          console.error('Error in pose detection:', error);
          // Restart camera if there's an error
          camera.stop();
          setTimeout(() => startCamera(), 1000);
        }
      },
      width: 400,
      height: 300
    });

    // Add error handling for camera
    videoElement.addEventListener('error', (e) => {
      console.error('Camera error:', e);
      // Try to restart the camera
      camera.stop();
      setTimeout(() => startCamera(), 1000);
    });

    function startCamera() {
      // Only start camera if disclaimer has been closed
      if (disclaimerShown) {
        camera.start().catch(error => {
          console.error('Failed to start camera:', error);
          // Try to restart after a delay
          setTimeout(() => startCamera(), 1000);
        });
      }
    }

    // Disclaimer popup functionality is handled by closeDisclaimer() function

    function closeDisclaimer() {
      document.getElementById('disclaimer-popup').classList.remove('active');
      disclaimerShown = true;
      // Now show workout config
      showWorkoutConfig();
      // Start camera after disclaimer is closed
      if (!cameraStarted) {
        startCamera();
        cameraStarted = true;
      }
    }

    function showDisclaimer() {
      document.getElementById('disclaimer-popup').classList.add('active');
      // Start voice control for disclaimer
      if (!isListening) {
        toggleVoiceControl();
      }
    }
  </script>
</body>
</html>